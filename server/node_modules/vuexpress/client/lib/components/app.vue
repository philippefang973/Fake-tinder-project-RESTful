<template>
  <div class="app">
    <v-pull class="view-wrapper" :enable="enableRefresh" @refresh="refresh">
      <transition :name="routerTransitionName" mode="in-out">
        <keep-alive v-if="$router.options.keepAlive">
          <router-view ref="view" class="view"></router-view>
        </keep-alive>
        <router-view ref="view" v-else class="view"></router-view>
      </transition>
    </v-pull>
    <v-dock ref="dock" :dock="dock" :path="$route.path"></v-dock>
  </div>
</template>

<script>

import Vue from 'vue'
import PullComponent from './pull.vue'
import DockComponent from './dock.vue'

export default {
  components: {
    'v-pull': PullComponent,
    'v-dock': DockComponent
  },
  props: ['dock'],
  data() {
    return {
      routerTransitionName: 'view-static',
      routerTracks: JSON.parse(window.localStorage.getItem('vuexpress_router_tracks')) || {}
    }
  },
  watch: {
    '$route'(to, from) {
      if (from.matched.length === 0 || this.$refs.dock.isDockPath(to.path) && this.$refs.dock.isDockPath(from.path)) {
        this.routerTransitionName = 'view-static'
      }
      else if (this.routerTracks[to.path + '->' + from.path]) {
        this.routerTransitionName = 'view-slide-right'
      }
      else {
        this.routerTransitionName = 'view-slide-left'
        this.routerTracks[from.path + '->' + to.path] = true
        window.localStorage.setItem('vuexpress_router_tracks', JSON.stringify(this.routerTracks))
      }
    }
  },
  methods: {
    enableRefresh() {
      return this.$refs.view.$options.refresh
    },
    refresh() {
      this.$refs.view.$options.refresh.call(this.$refs.view)
    }
  }
}

</script>

<style lang="stylus">

  [data-icon]::before
    content attr(data-icon)
    speak none
    font-style normal
    font-weight normal
    font-variant normal
    text-transform none
    line-height 1

    /* Enable Ligatures ================ */
    letter-spacing 0
    -webkit-font-feature-settings "liga"
    font-feature-settings "liga"
    -webkit-font-variant-ligatures discretionary-ligatures
    font-variant-ligatures discretionary-ligatures

    /* Better Font Rendering =========== */
    -webkit-font-smoothing antialiased

  *
    margin 0
    padding 0
    -webkit-tap-highlight-color rgba(0,0,0,0)

  html
    height 100%

  body
    font menu
    user-select none
    height 100%

  .app
    height 100%
    display flex
    flex-direction column

  .view-wrapper
    flex 1
    height 0

  .view
    position absolute
    left 0
    right 0
    top 0
    bottom 0
    overflow auto
    overflow-scrolling touch
    background white


  .view-slide-left-enter-active,
  .view-slide-right-leave-active
    transition transform 0.5s
    z-index 2147483647
    position fixed

  .view-slide-left-enter,
  .view-slide-right-leave-to
    transform translate3d(100%, 0, 0)

  .view-slide-left-leave
    z-index -1

  .view-slide-right-enter
    z-index -1


</style>
