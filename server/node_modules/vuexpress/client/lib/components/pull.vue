<template>
  <div class="view-pull" @touchstart="pullStart" @touchmove="pull" @touchend="pullEnd">
    <v-pull-animation ref="pullAnimation"></v-pull-animation>
    <div class="view-pull-body" :style="pullAnimation">
      <slot></slot>
    </div>
  </div>
</template>

<script>

import PullAnimationComponent from './pull_animation.vue'

export default {
  components: {
    'v-pull-animation': PullAnimationComponent
  },
  props: {
    enable: {
      type: Function,
      default: function () { return false }
    }
  },
  data() {
    return {
      pullStartPointY: 0,
      pullShiftY: 0,
      pullLength: 0,
      pullRestoreTime: 0
    }
  },
  computed: {
    pullAnimation() {
      return {
        transform: `translateY(${this.pullShiftY}px)`,
        transition: 'transform',
        transitionDuration: `${this.pullRestoreTime}s`
      }
    },
  },
  mounted() {
    this.pullLength = this.$refs.pullAnimation.$el.offsetHeight
  },
  methods: {
    pullStart(e) {
      if (this.enable() && e.touches.length === 1 && this.pullStartPointY === 0) {
        let element = e.target
        do {
          if (element.classname === 'view-wrapper') {
            break
          }
          if (element.scrollHeight > element.clientHeight && element.scrollTop > 0) {
            return
          }
        }
        while (element = element.parentNode)
        this.pullStartPointY = e.touches[0].clientY
        this.pullRestoreTime = 0
      }
    },
    pull(e) {
      if (this.pullStartPointY) {
        let dy = e.touches[0].clientY - this.pullStartPointY
        if (dy > 0) {
          dy = dy > this.pullLength ? this.pullLength : dy
          this.$refs.pullAnimation.draw(dy / this.pullLength)
          this.pullShiftY = dy
          e.preventDefault()
        }
      }
    },
    pullEnd() {
      if (this.pullShiftY === this.pullLength) {
        this.$refs.pullAnimation.loading(() => {
          this.pullStartPointY = 0
          this.pullShiftY = 0
          this.pullRestoreTime = 0.5
        })
        this.$emit('refresh')
      }
      else {
        this.pullStartPointY = 0
        this.pullShiftY = 0
        this.pullRestoreTime = 0.5
      }
    }
  }
}
  
</script>

<style lang="stylus">

  .view-pull
    position relative

  .view-pull-body
    position absolute
    left 0
    right 0
    top 0
    bottom 0

</style>
