<template>
  <div class="view-pull-animation">
    <canvas class="view-pull-circle" width="100" height="100"></canvas>
  </div>
</template>

<script>

const circleGrayColor = '#cccccc'
const circleHighlightColor = '#fc9153'

const animation = function (iterable, done = () => {}, frames = 60) {
  let running = true
  let frame = 0
  function closure(timestamp) {
    if (!running) { return }
    iterable(timestamp, ++frame, frames)
    if (frame < frames) {
      window.requestAnimationFrame(closure)
    }
    else {
      done()
    }
  }
  window.requestAnimationFrame(closure)
  return () => {
    running = false
  }
}

export default {
  mounted() {
    this.ctx = this.$el.querySelector('canvas').getContext('2d')
    this.ctx.lineWidth = 15
  },
  methods: {
    draw(rad) {
      if (rad < 0.25) { return }
      const ctx = this.ctx
      ctx.clearRect(0, 0, 100, 100)
      ctx.beginPath()
      ctx.arc(50, 50, 40, 0, Math.PI * 2)
      ctx.strokeStyle = circleGrayColor
      ctx.stroke()
      ctx.beginPath()
      ctx.arc(50, 50, 40, Math.PI * 2 * 0.75, Math.PI * 2 * 0.75 + Math.PI * 2 * (rad - 0.25) / 0.75)
      ctx.strokeStyle = circleHighlightColor
      ctx.stroke()
    },
    loading(callback) {
      const ctx = this.ctx
      const start = function factory(appear) {
        let length = Math.PI * 2 * 0.85
        let frames = 40
        let inter = 0

        ;(function closure() {
          ctx.clearRect(0, 0, 100, 100)
          ctx.beginPath()
          ctx.arc(50, 50, 40, appear ? 0 : length, length / frames * (++inter), !appear)
          ctx.stroke()
          if (inter === frames) {
            if (appear) {
              factory(!appear)
            }
            else {
              callback()
            }
          }
          else {
            requestAnimationFrame(closure)
          }
        })()
      }

      ctx.strokeStyle = circleHighlightColor

      start(true)
    }
  }
}

</script>

<style lang="stylus">

  .view-pull-animation
    height 1.5rem

  .view-pull-circle
    width 0.5rem
    height 0.5rem
    position absolute
    top 0.5rem
    left 50%
    transform translateX(-50%)

</style>
